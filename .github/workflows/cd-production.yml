name: CD - Production

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types: [completed]
    
env:
  APP_DIR: /var/www/frontend
  BACKUP_DIR: /var/www/backup
  TMP_DIR: /tmp/frontend-prod
  DOMAIN_URL: https://klosetlab.site

jobs:
  deploy-production:
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest

    environment:
      name: production
      url: https://klosetlab.site

    steps:
      # 1. CI ì‚°ì¶œë¬¼ ë‹¤ìš´ë¡œë“œ
      - name: Download CI artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-main
          path: ./build
          run-id: ${{ github.event.workflow_run.id }}
          
      # 2. ì‚°ì¶œë¬¼ ì„œë²„ë¡œ ì „ì†¡ - tmp ìœ„ì¹˜
      - name: Upload build to server (tmp)
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          source: "build/*"
          target: "/tmp/frontend-prod"
          strip_components: 1

      # 3. SSH ì§ì ‘ ë°°í¬ (ë°±ì—… + rsync + í—¬ìŠ¤ì²´í¬)
      - name: Deploy via SSH (backup & rsync)
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -e

            TIMESTAMP=$(date +%Y%m%d%H%M%S)

            echo "ğŸ“¦ Backup current version"
            sudo mkdir -p ${{ env.BACKUP_DIR }}
            if [ -d "${{ env.APP_DIR }}" ]; then
              sudo cp -r ${{ env.APP_DIR }} ${{ env.BACKUP_DIR }}/frontend_$TIMESTAMP
              sudo ln -sfn ${{ env.BACKUP_DIR }}/frontend_$TIMESTAMP ${{ env.BACKUP_DIR }}/latest
            fi

            echo "ğŸš€ Deploy new version"
            sudo mkdir -p ${{ env.APP_DIR }}
            sudo rsync -av --delete ${{ env.TMP_DIR }}/ ${{ env.APP_DIR }}/
            sudo chown -R www-data:www-data ${{ env.APP_DIR }}

            echo "ğŸ”„ Reload nginx"
            sudo nginx -t && sudo systemctl reload nginx
            sleep 2

            echo "ğŸ©º Health check"
            curl -f ${{ env.DOMAIN_URL }} || exit 1

      # 4. ì‹¤íŒ¨ ì‹œ ìë™ ë¡¤ë°±
      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            echo "âš ï¸ Rolling back to previous version"
            if [ -L "${{ env.BACKUP_DIR }}/latest" ]; then
              sudo rm -rf ${{ env.APP_DIR }}
              sudo cp -r ${{ env.BACKUP_DIR }}/latest ${{ env.APP_DIR }}
              sudo chown -R www-data:www-data ${{ env.APP_DIR }}
              sudo nginx -t && sudo systemctl reload nginx
            else
              echo "âŒ No backup found. Manual intervention required."
              exit 1
            fi

      # 5. Discord ì•Œë¦¼
      - name: Notify Discord
        if: always()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "${{ success() && 'âœ… Frontend Production ë°°í¬ ì„±ê³µ' || 'âŒ Frontend Production ë°°í¬ ì‹¤íŒ¨ (ë¡¤ë°± ì™„ë£Œ)' }}"
          embed-description: |
            **ë¸Œëœì¹˜:** `main`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha }}`
            **ë°°í¬ì:** ${{ github.event.workflow_run.head_commit.author.name }}

            ${{ failure() && 'âš ï¸ ë°°í¬ ì‹¤íŒ¨ë¡œ ì´ì „ ë²„ì „ìœ¼ë¡œ ìë™ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤.' || '' }}

            [ğŸ“‹ CD ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            [ğŸŒ ì„œë¹„ìŠ¤ í™•ì¸](${{ env.DOMAIN_URL }})
          embed-color: ${{ success() && '3066993' || '15158332' }}