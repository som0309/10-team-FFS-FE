name: Frontend CI/CD

on:
  # PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ CIë§Œ ì‹¤í–‰
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

  # ë¨¸ì§€(push) ì‹œ CI + CD ì‹¤í–‰
  push:
    branches: [main]

env:
  APP_DIR: /var/www/frontend
  BACKUP_DIR: /var/www/backup
  TMP_DIR: /tmp/frontend-prod
  DOMAIN_URL: https://klosetlab.site

jobs:
  # ==================== CI Job ====================
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        id: install
        run: npm ci

      - name: Run lint
        id: lint
        run: npm run lint

      - name: Build project
        id: build
        run: npm run build

      - name: Run tests
        id: tests
        run: npm test -- --watch=false --passWithNoTests

      # main ë¸Œëœì¹˜ì— pushëœ ê²½ìš°ì—ë§Œ artifact ì €ì¥
      - name: Upload build artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-main
          path: build
          retention-days: 90

      - name: Notify Discord - CI Success
        if: success()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CI Bot"
          embed-title: "âœ… Frontend CI ì„±ê³µ"
          embed-description: |
            **ì´ë²¤íŠ¸:** ${{ github.event_name }}
            **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
            **ì‹¤í–‰ì:** ${{ github.actor }}

            â€¢ Install: ${{ steps.install.outcome }}
            â€¢ ESLint: ${{ steps.lint.outcome }}
            â€¢ Build: ${{ steps.build.outcome }}
            â€¢ Tests: ${{ steps.tests.outcome }}

      - name: Notify Discord - CI Failure
        if: failure()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CI Bot"
          embed-title: "âŒ Frontend CI ì‹¤íŒ¨"
          embed-description: |
            **ì´ë²¤íŠ¸:** ${{ github.event_name }}
            **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
            **ì‹¤í–‰ì:** ${{ github.actor }}

            â€¢ Install: ${{ steps.install.outcome }}
            â€¢ ESLint: ${{ steps.lint.outcome }}
            â€¢ Build: ${{ steps.build.outcome }}
            â€¢ Tests: ${{ steps.tests.outcome }}

  # ==================== CD Job ====================
  cd:
    name: Deploy to Production
    needs: ci
    # main ë¸Œëœì¹˜ì— pushëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    # ìˆ˜ë™ ìŠ¹ì¸ ì„¤ì •
    environment:
      name: production
      url: https://klosetlab.site

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-main
          path: ./build

      - name: Upload build to server (tmp)
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          source: "build/*"
          target: "/tmp/frontend-prod"
          strip_components: 1

      - name: Deploy via SSH (backup & rsync)
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -e

            TIMESTAMP=$(date +%Y%m%d%H%M%S)

            echo "ğŸ“¦ Backup current version"
            sudo mkdir -p ${{ env.BACKUP_DIR }}
            if [ -d "${{ env.APP_DIR }}" ]; then
              sudo cp -r ${{ env.APP_DIR }} ${{ env.BACKUP_DIR }}/frontend_$TIMESTAMP
              sudo ln -sfn ${{ env.BACKUP_DIR }}/frontend_$TIMESTAMP ${{ env.BACKUP_DIR }}/latest
            fi

            echo "ğŸš€ Deploy new version"
            sudo mkdir -p ${{ env.APP_DIR }}
            sudo rsync -av --delete ${{ env.TMP_DIR }}/ ${{ env.APP_DIR }}/
            sudo chown -R www-data:www-data ${{ env.APP_DIR }}

            echo "ğŸ”„ Reload nginx"
            sudo nginx -t && sudo systemctl reload nginx
            sleep 2

            echo "ğŸ©º Health check"
            curl -f ${{ env.DOMAIN_URL }} || exit 1

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            echo "âš ï¸ Rolling back to previous version"
            if [ -L "${{ env.BACKUP_DIR }}/latest" ]; then
              sudo rm -rf ${{ env.APP_DIR }}
              sudo cp -r ${{ env.BACKUP_DIR }}/latest ${{ env.APP_DIR }}
              sudo chown -R www-data:www-data ${{ env.APP_DIR }}
              sudo nginx -t && sudo systemctl reload nginx
            else
              echo "âŒ No backup found. Manual intervention required."
              exit 1
            fi

      - name: Notify Discord - CD Success
        if: success()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CD Bot"
          embed-title: "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ"
          embed-description: |
            **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
            **ì‹¤í–‰ì:** ${{ github.actor }}
            **ì»¤ë°‹:** `${{ github.sha }}`
            **URL:** https://klosetlab.site

      - name: Notify Discord - CD Failure
        if: failure()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CD Bot"
          embed-title: "âŒ í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨"
          embed-description: |
            **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
            **ì‹¤í–‰ì:** ${{ github.actor }}
            **ì»¤ë°‹:** `${{ github.sha }}`
            
            ë¡¤ë°±ì´ ì‹œë„ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.