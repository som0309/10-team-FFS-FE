name: Frontend CD - Staging

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types: [completed]

env:
  BUILD_DIR: /var/www/html/staging

jobs:
  deploy-staging:
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'dev'
    runs-on: ubuntu-latest
    environment: staging

    steps:
      # 1. CI 산출물 다운로드
      - name: Download CI artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          name: frontend-build-dev
          path: ./build
          run-id: ${{ github.event.workflow_run.id }}

      # 2. 서버 업로드
      - name: Upload files
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          source: "build/*"
          target: "/tmp/frontend-staging"
          strip_components: 1

      # 3. 배포 + 헬스체크
      - name: Deploy & Health Check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            sudo rm -rf ${{ env.BUILD_DIR }}/*
            sudo mkdir -p ${{ env.BUILD_DIR }}
            sudo mv /tmp/frontend-staging/* ${{ env.BUILD_DIR }}/
            sudo chown -R www-data:www-data ${{ env.BUILD_DIR }}

            sudo nginx -t && sudo systemctl reload nginx
            sleep 2
            curl -f http://localhost/staging || exit 1
            
      # 4. Discord 알림
      - name: Notify Discord - CD Success
        if: success()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CD Bot"
          embed-title: "✅ Frontend CD 성공"
          embed-description: |
            **이벤트:** ${{ github.event_name }}
            **브랜치:** `${{ github.ref_name }}`
            **실행자:** ${{ github.actor }}
            
      - name: Notify Discord - CDFailure
        if: failure()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CD Bot"
          embed-title: "❌ Frontend CD 실패"
          embed-description: |
            **이벤트:** ${{ github.event_name }}
            **브랜치:** `${{ github.ref_name }}`
            **실행자:** ${{ github.actor }}