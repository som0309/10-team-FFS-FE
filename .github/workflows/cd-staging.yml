name: Frontend CD - Staging

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types: [completed]

env:
  BUILD_DIR: /var/www/html/staging

jobs:
  deploy-staging:
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'dev'
    runs-on: ubuntu-latest
    environment: staging

    steps:
      # 1. CI ì‚°ì¶œë¬¼ ë‹¤ìš´ë¡œë“œ
      - name: Download CI artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-dev
          path: ./build
          run-id: ${{ github.event.workflow_run.id }}

		  # 2. ì„œë²„ ì—…ë¡œë“œ
      - name: Upload files
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          source: "build/*"
          target: "/tmp/frontend-staging"
          strip_components: 1

      # 3. ë°°í¬ + í—¬ìŠ¤ì²´í¬
      - name: Deploy & Health Check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            sudo rm -rf ${{ env.BUILD_DIR }}/*
            sudo mkdir -p ${{ env.BUILD_DIR }}
            sudo mv /tmp/frontend-staging/* ${{ env.BUILD_DIR }}/
            sudo chown -R www-data:www-data ${{ env.BUILD_DIR }}

            sudo nginx -t && sudo systemctl reload nginx
            sleep 2
            curl -f http://localhost/staging || exit 1
            
      # 4. Discord ì•Œë¦¼
      - name: Notify Discord
        if: always()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "${{ success() && 'âœ… Frontend Staging ë°°í¬ ì„±ê³µ' || 'âŒ Frontend Staging ë°°í¬ ì‹¤íŒ¨' }}"
          embed-description: |
            **ë¸Œëœì¹˜:** `dev`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha }}`
            **ë°°í¬ì:** ${{ github.event.workflow_run.head_commit.author.name }}
            
            [ğŸ“‹ CD ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: ${{ success() && '3066993' || '15158332' }}