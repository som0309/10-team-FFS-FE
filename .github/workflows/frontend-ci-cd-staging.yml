name: Frontend CI/CD - Staging

on:
  # PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ CIë§Œ ì‹¤í–‰
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [dev]

  # dev ë¸Œëœì¹˜ ë¨¸ì§€ ì‹œ CI + CD ì‹¤í–‰
  push:
    branches: [dev]

env:
  BUILD_DIR: /var/www/html/staging

jobs:
  # ==================== CI Job ====================
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        id: install
        run: npm ci

      - name: Run lint
        id: lint
        run: npm run lint

      - name: Build project
        id: build
        run: npm run build

      - name: Run tests
        id: tests
        run: npm test -- --watch=false --passWithNoTests

      # dev ë¸Œëœì¹˜ì— pushëœ ê²½ìš°ì—ë§Œ artifact ì €ì¥
      - name: Upload build artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-dev
          path: build
          retention-days: 7

      - name: Notify Discord - CI Success
        if: success()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CI Bot"
          embed-title: "âœ… Frontend CI ì„±ê³µ"
          embed-description: |
            **ì´ë²¤íŠ¸:** ${{ github.event_name }}
            **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
            **ì‹¤í–‰ì:** ${{ github.actor }}

            â€¢ Install: ${{ steps.install.outcome }}
            â€¢ ESLint: ${{ steps.lint.outcome }}
            â€¢ Build: ${{ steps.build.outcome }}
            â€¢ Tests: ${{ steps.tests.tests.outcome }}

      - name: Notify Discord - CI Failure
        if: failure()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CI Bot"
          embed-title: "âŒ Frontend CI ì‹¤íŒ¨"
          embed-description: |
            **ì´ë²¤íŠ¸:** ${{ github.event_name }}
            **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
            **ì‹¤í–‰ì:** ${{ github.actor }}

            â€¢ Install: ${{ steps.install.outcome }}
            â€¢ ESLint: ${{ steps.lint.outcome }}
            â€¢ Build: ${{ steps.build.outcome }}
            â€¢ Tests: ${{ steps.tests.outcome }}

  # ==================== CD Job ====================
  cd:
    name: Deploy to Staging
    needs: ci
    # dev ë¸Œëœì¹˜ì— pushëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-dev
          path: ./build

      - name: Upload files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          source: "build/*"
          target: "/tmp/frontend-staging"
          strip_components: 1

      - name: Deploy & Health Check
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            set -e

            echo "ğŸš€ Deploy new version"
            sudo rm -rf ${{ env.BUILD_DIR }}/*
            sudo mkdir -p ${{ env.BUILD_DIR }}
            sudo mv /tmp/frontend-staging/* ${{ env.BUILD_DIR }}/
            sudo chown -R www-data:www-data ${{ env.BUILD_DIR }}

            echo "ğŸ”„ Reload nginx"
            sudo nginx -t && sudo systemctl reload nginx
            sleep 2

            echo "ğŸ©º Health check"
            curl -f http://localhost/staging || exit 1

      - name: Notify Discord - CD Success
        if: success()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CD Bot"
          embed-title: "âœ… Staging ë°°í¬ ì„±ê³µ"
          embed-description: |
            **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
            **ì‹¤í–‰ì:** ${{ github.actor }}
            **ì»¤ë°‹:** `${{ github.sha }}`
            **í™˜ê²½:** Staging

      - name: Notify Discord - CD Failure
        if: failure()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Frontend CD Bot"
          embed-title: "âŒ Staging ë°°í¬ ì‹¤íŒ¨"
          embed-description: |
            **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
            **ì‹¤í–‰ì:** ${{ github.actor }}
            **ì»¤ë°‹:** `${{ github.sha }}`
            **í™˜ê²½:** Staging
            
            ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.